<!DOCTYPE html>












  


<html class="theme-next gemini use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">










  <meta name="google-site-verification" content="2_gvJ0AU4BQMbo71lVLx7ZFue1PuEupJjYtJtYYvWfI">







  <meta name="baidu-site-verification" content="NGZiuIq8y3">











<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2">

<link rel="stylesheet" href="/css/main.css?v=7.0.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=7.0.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=7.0.0">


  <link rel="mask-icon" href="/images/logo.svg?v=7.0.0" color="#222">







<script id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '7.0.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":true,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <meta name="description" content="前言Spring是一个全面的、企业应用开发一站式的解决方案，贯穿表现层、业务层、持久层。但是Spring仍然可以和其他的框架无缝整合。">
<meta name="keywords" content="java,spring">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring原理">
<meta property="og:url" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/index.html">
<meta property="og:site_name" content="Shado&#39;s Blog">
<meta property="og:description" content="前言Spring是一个全面的、企业应用开发一站式的解决方案，贯穿表现层、业务层、持久层。但是Spring仍然可以和其他的框架无缝整合。">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-feature.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-component.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-module.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-main-package.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-annotation.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-integration.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-component-2.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/beanfactory.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/applicationcontext.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/webapplicationcontext.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-bean-lifecycle.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-aop.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-aop-2.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-mvc-process.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-mvc-annotation.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/transaction.jpg">
<meta property="og:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/mybatis-cache.jpg">
<meta property="og:updated_time" content="2019-06-19T02:14:41.883Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Spring原理">
<meta name="twitter:description" content="前言Spring是一个全面的、企业应用开发一站式的解决方案，贯穿表现层、业务层、持久层。但是Spring仍然可以和其他的框架无缝整合。">
<meta name="twitter:image" content="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/spring-feature.jpg">



  <link rel="alternate" href="/atom.xml" title="Shado's Blog" type="application/atom+xml">




  <link rel="canonical" href="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/">



<script id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>Spring原理 | Shado's Blog</title>
  






  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2e95519f99e1c36388001fcde9a63479";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>







  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Shado's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-user"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  



</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://www.shado.com.cn/2018/07/09/2018-07-09-spring-principle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Shado Fung">
      <meta itemprop="description" content="Java Developer">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Shado's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Spring原理

              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-07-09 20:15:32" itemprop="dateCreated datePublished" datetime="2018-07-09T20:15:32+08:00">2018-07-09</time>
            

            
              

              
                
                <span class="post-meta-divider">|</span>
                

                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                
                  <span class="post-meta-item-text">更新于</span>
                
                <time title="修改时间：2019-06-19 10:14:41" itemprop="dateModified" datetime="2019-06-19T10:14:41+08:00">2019-06-19</time>
              
            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/spring/" itemprop="url" rel="index"><span itemprop="name">spring</span></a></span>

                
                
              
            </span>
          

          
            
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">16k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">27 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Spring是一个全面的、企业应用开发一站式的解决方案，贯穿表现层、业务层、持久层。但是Spring仍然可以和其他的框架无缝整合。<br><a id="more"></a></p>
<h2 id="Spring特点"><a href="#Spring特点" class="headerlink" title="Spring特点"></a>Spring特点</h2><h3 id="轻量级"><a href="#轻量级" class="headerlink" title="轻量级"></a>轻量级</h3><h3 id="控制反转"><a href="#控制反转" class="headerlink" title="控制反转"></a>控制反转</h3><h3 id="面向切面"><a href="#面向切面" class="headerlink" title="面向切面"></a>面向切面</h3><h3 id="容器"><a href="#容器" class="headerlink" title="容器"></a>容器</h3><h3 id="框架集合"><a href="#框架集合" class="headerlink" title="框架集合"></a>框架集合</h3><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-feature.jpg" alt="Spring Feature"></p>
<h2 id="Spring核心组件"><a href="#Spring核心组件" class="headerlink" title="Spring核心组件"></a>Spring核心组件</h2><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-component.jpg" alt="Spring Component"></p>
<h2 id="Spring常用模块"><a href="#Spring常用模块" class="headerlink" title="Spring常用模块"></a>Spring常用模块</h2><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-module.jpg" alt="Spring Module"></p>
<h2 id="Spring主要包"><a href="#Spring主要包" class="headerlink" title="Spring主要包"></a>Spring主要包</h2><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-main-package.jpg" alt="Spring Package"></p>
<h2 id="常用注解"><a href="#常用注解" class="headerlink" title="常用注解"></a>常用注解</h2><p>bean 注入与装配的的方式有很多种，可以通过xml，get set 方式，构造函数或者注解等。简单易用的方式就是使用Spring 的注解了，Spring 提供了大量的注解方式。<br><img src="/2018/07/09/2018-07-09-spring-principle/spring-annotation.jpg" alt="Spring Annotation"></p>
<h2 id="Spring第三方结合"><a href="#Spring第三方结合" class="headerlink" title="Spring第三方结合"></a>Spring第三方结合</h2><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-integration.jpg" alt="Spring Integration"></p>
<h2 id="Spring-IOC原理"><a href="#Spring-IOC原理" class="headerlink" title="Spring IOC原理"></a>Spring IOC原理</h2><h3 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h3><p>Spring 通过一个配置文件描述 Bean 及 Bean 之间的依赖关系，利用 Java 语言的反射功能实例化Bean 并建立 Bean 之间的依赖关系。 Spring 的 IoC 容器在完成这些底层工作的基础上，还提供了 Bean 实例缓存、生命周期管理、 Bean 实例代理、事件发布、资源装载等高级服务。</p>
<h3 id="Spring-容器高层视图"><a href="#Spring-容器高层视图" class="headerlink" title="Spring 容器高层视图"></a>Spring 容器高层视图</h3><p>Spring 启动时读取应用程序提供的Bean 配置信息，并在Spring 容器中生成一份相应的Bean 配置注册表，然后根据这张注册表实例化Bean，装配好Bean 之间的依赖关系，为上层应用提供准备就绪的运行环境。其中Bean 缓存池为HashMap 实现。<br><img src="/2018/07/09/2018-07-09-spring-principle/spring-component-2.jpg" alt="Spring Component"></p>
<h3 id="IOC容器实现"><a href="#IOC容器实现" class="headerlink" title="IOC容器实现"></a>IOC容器实现</h3><h4 id="BeanFactory-框架基础设施"><a href="#BeanFactory-框架基础设施" class="headerlink" title="BeanFactory-框架基础设施"></a>BeanFactory-框架基础设施</h4><p>BeanFactory 是 Spring 框架的基础设施，面向 Spring 本身；ApplicationContext 面向使用Spring 框架的开发者，几乎所有的应用场合我们都直接使用 ApplicationContext 而非底层的 BeanFactory。<br><img src="/2018/07/09/2018-07-09-spring-principle/beanfactory.jpg" alt="BeanFactory"></p>
<h5 id="BeanDefinitionRegistry-注册表"><a href="#BeanDefinitionRegistry-注册表" class="headerlink" title="BeanDefinitionRegistry 注册表"></a>BeanDefinitionRegistry 注册表</h5><ol>
<li>Spring 配置文件中每一个节点元素在 Spring 容器里都通过一个 BeanDefinition 对象表示，它描述了 Bean 的配置信息。而 BeanDefinitionRegistry 接口提供了向容器手工注册BeanDefinition 对象的方法。</li>
</ol>
<h5 id="BeanFactory-顶层接口"><a href="#BeanFactory-顶层接口" class="headerlink" title="BeanFactory 顶层接口"></a>BeanFactory 顶层接口</h5><ol start="2">
<li>位于类结构树的顶端 ，它最主要的方法就是 getBean(String beanName)，该方法从容器中返回特定名称的 Bean，BeanFactory 的功能通过其他的接口得到不断扩展：</li>
</ol>
<h5 id="ListableBeanFactory"><a href="#ListableBeanFactory" class="headerlink" title="ListableBeanFactory"></a>ListableBeanFactory</h5><ol start="3">
<li>该接口定义了访问容器中 Bean 基本信息的若干方法，如查看Bean 的个数、获取某一类型Bean 的配置名、查看容器中是否包括某一 Bean 等方法；</li>
</ol>
<h5 id="HierarchicalBeanFactory父子级联"><a href="#HierarchicalBeanFactory父子级联" class="headerlink" title="HierarchicalBeanFactory父子级联"></a>HierarchicalBeanFactory父子级联</h5><ol start="4">
<li>父子级联 IoC 容器的接口，子容器可以通过接口方法访问父容器； 通过HierarchicalBeanFactory 接口， Spring 的 IoC 容器可以建立父子层级关联的容器体系，子容器可以访问父容器中的 Bean，但父容器不能访问子容器的 Bean。Spring 使用父子容器实现了很多功能，比如在 Spring MVC 中，展现层 Bean 位于一个子容器中，而业务层和持久层的 Bean 位于父容器中。这样，展现层 Bean 就可以引用业务层和持久层的 Bean，而业务层和持久层的 Bean 则看不到展现层的 Bean。</li>
</ol>
<h5 id="ConfigurableBeanFactory"><a href="#ConfigurableBeanFactory" class="headerlink" title="ConfigurableBeanFactory"></a>ConfigurableBeanFactory</h5><ol start="5">
<li>是一个重要的接口，增强了 IoC 容器的可定制性，它定义了设置类装载器、属性编辑器、容器初始化后置处理器等方法；</li>
</ol>
<h5 id="AutowireCapableBeanFactory-自动装配"><a href="#AutowireCapableBeanFactory-自动装配" class="headerlink" title="AutowireCapableBeanFactory 自动装配"></a>AutowireCapableBeanFactory 自动装配</h5><ol start="6">
<li>定义了将容器中的 Bean 按某种规则（如按名字匹配、按类型匹配等）进行自动装配的方法；</li>
</ol>
<h5 id="SingletonBeanRegistry-运行期间注册单例-Bean"><a href="#SingletonBeanRegistry-运行期间注册单例-Bean" class="headerlink" title="SingletonBeanRegistry 运行期间注册单例 Bean"></a>SingletonBeanRegistry 运行期间注册单例 Bean</h5><ol start="7">
<li>定义了允许在运行期间向容器注册单实例 Bean 的方法；对于单实例（ singleton）的 Bean来说，BeanFactory 会缓存 Bean 实例，所以第二次使用 getBean() 获取 Bean 时将直接从IoC 容器的缓存中获取 Bean 实例。Spring 在 DefaultSingletonBeanRegistry 类中提供了一个用于缓存单实例 Bean 的缓存器，它是一个用HashMap 实现的缓存器，单实例的 Bean 以beanName 为键保存在这个HashMap 中。</li>
</ol>
<h5 id="依赖日志框架"><a href="#依赖日志框架" class="headerlink" title="依赖日志框架"></a>依赖日志框架</h5><ol start="8">
<li>在初始化 BeanFactory 时，必须为其提供一种日志框架，比如使用Log4J， 即在类路径下提供 Log4J 配置文件，这样启动 Spring 容器才不会报错。</li>
</ol>
<h4 id="ApplicationContext"><a href="#ApplicationContext" class="headerlink" title="ApplicationContext"></a>ApplicationContext</h4><p>ApplicationContext 由 BeanFactory 派生而来， 提供了更多面向实际应用的功能。ApplicationContext 继承了 HierarchicalBeanFactory 和 ListableBeanFactory 接口，在此基础上，还通过多个其他的接口扩展了 BeanFactory 的功能：<br><img src="/2018/07/09/2018-07-09-spring-principle/applicationcontext.jpg" alt="ApplicationContext"></p>
<ol>
<li>ClassPathXmlApplicationContext：默认从类路径加载配置文件</li>
<li>FileSystemXmlApplicationContext：默认从文件系统中装载配置文件</li>
<li>ApplicationEventPublisher：让容器拥有发布应用上下文事件的功能，包括容器启动事件、关闭事件等。</li>
<li>MessageSource：为应用提供 i18n 国际化消息访问的功能；</li>
<li>ResourcePatternResolver ： 所 有 ApplicationContext 实现类都实现了类似于PathMatchingResourcePatternResolver 的功能，可以通过带前缀的 Ant 风格的资源文件路径装载 Spring 的配置文件。</li>
<li>LifeCycle：该接口是 Spring 2.0 加入的，该接口提供了 start()和 stop()两个方法，主要用于控制异步处理过程。在具体使用时，该接口同时被 ApplicationContext 实现及具体Bean 实现， ApplicationContext 会将 start/stop 的信息传递给容器中所有实现了该接口的 Bean，以达到管理和控制 JMX、任务调度等目的。</li>
<li>ConfigurableApplicationContext 扩展于 ApplicationContext，它新增加了两个主要的方法： refresh()和 close()，让 ApplicationContext 具有启动、刷新和关闭应用上下文的能力。在应用上下文关闭的情况下调用 refresh()即可启动应用上下文，在已经启动的状态下，调用 refresh()则清除缓存并重新装载配置信息，而调用close()则可关闭应用上下文。</li>
</ol>
<h4 id="WebApplication-体系架构"><a href="#WebApplication-体系架构" class="headerlink" title="WebApplication 体系架构"></a>WebApplication 体系架构</h4><p>WebApplicationContext 是专门为 Web 应用准备的，它允许从相对于 Web 根目录的路径中装载配置文件完成初始化工作。从WebApplicationContext 中可以获得ServletContext 的引用，整个 Web 应用上下文对象将作为属性放置到 ServletContext中，以便 Web 应用环境可以访问 Spring 应用上下文。<br><img src="/2018/07/09/2018-07-09-spring-principle/webapplicationcontext.jpg" alt="webapplicationcontext"></p>
<h3 id="Spring-Bean-作用域"><a href="#Spring-Bean-作用域" class="headerlink" title="Spring Bean 作用域"></a>Spring Bean 作用域</h3><p>Spring 3 中为Bean 定义了5 中作用域，分别为singleton（单例）、prototype（原型）、request、session 和global session，5 种作用域说明如下：</p>
<h4 id="singleton-单例模式-多线程下不安全"><a href="#singleton-单例模式-多线程下不安全" class="headerlink" title="singleton:单例模式(多线程下不安全)"></a>singleton:单例模式(多线程下不安全)</h4><ol>
<li>singleton：单例模式，Spring IoC 容器中只会存在一个共享的Bean 实例，无论有多少个Bean 引用它，始终指向同一对象。该模式在多线程下是不安全的。Singleton 作用域是Spring 中的缺省作用域，也可以显示的将Bean 定义为singleton 模式，配置为：</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean <span class="attribute">id</span>=<span class="string">"userDao"</span> <span class="attribute">class</span>=<span class="string">"com.ioc.UserDaoImpl"</span> <span class="attribute">scope</span>=<span class="string">"singleton"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h4 id="prototype-原型模式每次使用时创建"><a href="#prototype-原型模式每次使用时创建" class="headerlink" title="prototype:原型模式每次使用时创建"></a>prototype:原型模式每次使用时创建</h4><ol start="2">
<li>prototype:原型模式，每次通过Spring 容器获取prototype 定义的bean 时，容器都将创建一个新的Bean 实例，每个Bean 实例都有自己的属性和状态，而singleton 全局只有一个对象。根据经验，对有状态的bean使用prototype作用域，而对无状态的bean使用singleton作用域。</li>
</ol>
<h4 id="Request-一次-request-一个实例"><a href="#Request-一次-request-一个实例" class="headerlink" title="Request: 一次 request 一个实例"></a>Request: 一次 request 一个实例</h4><ol start="3">
<li>request：在一次Http 请求中，容器会返回该Bean 的同一实例。而对不同的Http 请求则会产生新的Bean，而且该bean 仅在当前Http Request 内有效,当前Http 请求结束，该bean实例也将会被销毁。</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean <span class="attribute">id</span>=<span class="string">"loginAction"</span> <span class="attribute">class</span>=<span class="string">"com.cnblogs.Login"</span> <span class="attribute">scope</span>=<span class="string">"request"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h4 id="session"><a href="#session" class="headerlink" title="session"></a>session</h4><ol start="4">
<li>session：在一次Http Session 中，容器会返回该Bean 的同一实例。而对不同的Session 请求则会创建新的实例，该bean 实例仅在当前Session 内有效。同Http 请求相同，每一次session 请求创建新的实例，而不同的实例之间不共享属性，且实例仅在自己的session 请求内有效，请求结束，则实例将被销毁。</li>
</ol>
<figure class="highlight routeros"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean <span class="attribute">id</span>=<span class="string">"userPreference"</span> <span class="attribute">class</span>=<span class="string">"com.ioc.UserPreference"</span> <span class="attribute">scope</span>=<span class="string">"session"</span>/&gt;</span><br></pre></td></tr></table></figure>
<h4 id="global-Session"><a href="#global-Session" class="headerlink" title="global Session"></a>global Session</h4><ol start="5">
<li>global Session：在一个全局的Http Session 中，容器会返回该Bean 的同一个实例，仅在使用portlet context 时有效。</li>
</ol>
<h3 id="Spring-Bean-生命周期"><a href="#Spring-Bean-生命周期" class="headerlink" title="Spring Bean 生命周期"></a>Spring Bean 生命周期</h3><h4 id="实例化"><a href="#实例化" class="headerlink" title="实例化"></a>实例化</h4><ol>
<li>实例化一个Bean，也就是我们常说的new。</li>
</ol>
<h4 id="IOC-依赖注入"><a href="#IOC-依赖注入" class="headerlink" title="IOC 依赖注入"></a>IOC 依赖注入</h4><ol start="2">
<li>按照Spring 上下文对实例化的Bean 进行配置，也就是IOC 注入。</li>
</ol>
<h4 id="setBeanName-实现"><a href="#setBeanName-实现" class="headerlink" title="setBeanName 实现"></a>setBeanName 实现</h4><ol start="3">
<li>如果这个Bean 已经实现了BeanNameAware 接口，会调用它实现的setBeanName(String)方法，此处传递的就是Spring 配置文件中Bean 的id 值</li>
</ol>
<h4 id="BeanFactoryAware-实现"><a href="#BeanFactoryAware-实现" class="headerlink" title="BeanFactoryAware 实现"></a>BeanFactoryAware 实现</h4><ol start="4">
<li>如果这个Bean 已经实现了BeanFactoryAware 接口，会调用它实现的setBeanFactory，setBeanFactory(BeanFactory)传递的是Spring 工厂自身（可以用这个方式来获取其它Bean，只需在Spring 配置文件中配置一个普通的Bean 就可以）。</li>
</ol>
<h4 id="ApplicationContextAware-实现"><a href="#ApplicationContextAware-实现" class="headerlink" title="ApplicationContextAware 实现"></a>ApplicationContextAware 实现</h4><ol start="5">
<li>如果这个Bean已经实现了ApplicationContextAware 接口，会调用setApplicationContext(ApplicationContext)方法，传入Spring 上下文（同样这个方式也可以实现步骤4 的内容，但比4 更好，因为ApplicationContext 是BeanFactory 的子接口，有更多的实现方法）</li>
</ol>
<h4 id="postProcessBeforeInitialization-接口实现-初始化预处理"><a href="#postProcessBeforeInitialization-接口实现-初始化预处理" class="headerlink" title="postProcessBeforeInitialization 接口实现-初始化预处理"></a>postProcessBeforeInitialization 接口实现-初始化预处理</h4><ol start="6">
<li>如果这个Bean 关联了BeanPostProcessor 接口，将会调用postProcessBeforeInitialization(Object obj, String s)方法，BeanPostProcessor 经常被用作是Bean 内容的更改，并且由于这个是在Bean 初始化结束时调用那个的方法，也可以被应用于内存或缓存技术。</li>
</ol>
<h4 id="init-method"><a href="#init-method" class="headerlink" title="init-method"></a>init-method</h4><ol start="7">
<li><p>如果Bean 在Spring 配置文件中配置了init-method 属性会自动调用其配置的初始化方法。postProcessAfterInitialization</p>
</li>
<li><p>如果这个Bean 关联了BeanPostProcessor 接口，将会调用postProcessAfterInitialization(Object obj, String s)方法。<br>注：以上工作完成以后就可以应用这个Bean 了，那这个Bean 是一个Singleton 的，所以一般情况下我们调用同一个id 的Bean 会是在内容地址相同的实例，当然在Spring 配置文件中也可以配置非Singleton。</p>
</li>
</ol>
<h4 id="Destroy-过期自动清理阶段"><a href="#Destroy-过期自动清理阶段" class="headerlink" title="Destroy 过期自动清理阶段"></a>Destroy 过期自动清理阶段</h4><ol start="9">
<li>当Bean 不再需要时，会经过清理阶段，如果Bean 实现了DisposableBean 这个接口，会调用那个其实现的destroy()方法；</li>
</ol>
<h4 id="destroy-method-自配置清理"><a href="#destroy-method-自配置清理" class="headerlink" title="destroy-method 自配置清理"></a>destroy-method 自配置清理</h4><ol start="10">
<li>最后，如果这个Bean 的Spring 配置中配置了destroy-method 属性，会自动调用其配置的销毁方法。</li>
</ol>
<p><img src="/2018/07/09/2018-07-09-spring-principle/spring-bean-lifecycle.jpg" alt="spring-bean-lifecycle"></p>
<ol start="11">
<li>bean 标签有两个重要的属性（init-method 和destroy-method）。用它们你可以自己定制初始化和注销方法。它们也有相应的注解（@PostConstruct 和@PreDestroy）。<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">""</span> <span class="attr">class</span>=<span class="string">""</span> <span class="attr">init-method</span>=<span class="string">"初始化方法"</span> <span class="attr">destroy-method</span>=<span class="string">"销毁方法"</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="Spring依赖注入的四种方式"><a href="#Spring依赖注入的四种方式" class="headerlink" title="Spring依赖注入的四种方式"></a>Spring依赖注入的四种方式</h3><h4 id="构造器注入"><a href="#构造器注入" class="headerlink" title="构造器注入"></a>构造器注入</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*带参数，方便利用构造器进行注入*/</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">CatDaoImpl</span><span class="params">(String message)</span></span>&#123;</span><br><span class="line">  <span class="keyword">this</span>. message = message;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"CatDaoImpl"</span> <span class="attr">class</span>=<span class="string">"com.CatDaoImpl"</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">constructor-arg</span> <span class="attr">value</span>=<span class="string">" message "</span>&gt;</span><span class="tag">&lt;/<span class="name">constructor-arg</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="setter方法注入"><a href="#setter方法注入" class="headerlink" title="setter方法注入"></a>setter方法注入</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Id</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getId</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> id; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setId</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123; <span class="keyword">this</span>.id = id; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"id"</span> <span class="attr">class</span>=<span class="string">"com.id "</span>&gt;</span> <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"id"</span> <span class="attr">value</span>=<span class="string">"123"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="静态工厂注入"><a href="#静态工厂注入" class="headerlink" title="静态工厂注入"></a>静态工厂注入</h4><p>静态工厂顾名思义，就是通过调用静态工厂的方法来获取自己需要的对象，为了让spring 管理所有对象，我们不能直接通过”工程类.静态方法()”来获取对象，而是依然通过spring 注入的形式获取：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 静态工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoFactory</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> FactoryDao <span class="title">getStaticFactoryDaoImpl</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> StaticFacotryDaoImpl();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAction</span> &#123;</span></span><br><span class="line">  <span class="comment">// 注入对象</span></span><br><span class="line">  <span class="keyword">private</span> FactoryDao staticFactoryDao;</span><br><span class="line">  <span class="comment">// 注入对象的 set 方法</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setStaticFactoryDao</span><span class="params">(FactoryDao staticFactoryDao)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.staticFactoryDao = staticFactoryDao;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--factory-method="getStaticFactoryDaoImpl" 指定调用哪个工厂方法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"springAction"</span> <span class="attr">class</span>=<span class="string">" SpringAction"</span> &gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 使用静态工厂的方法注入对象，对应下面的配置文件 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"staticFactoryDao"</span> <span class="attr">ref</span>=<span class="string">"staticFactoryDao"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 此处获取对象的方式是从工厂类中获取静态方法 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"staticFactoryDao"</span> <span class="attr">class</span>=<span class="string">"DaoFactory"</span> <span class="attr">factory-method</span>=<span class="string">"getStaticFactoryDaoImpl"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h4 id="实例工厂"><a href="#实例工厂" class="headerlink" title="实例工厂"></a>实例工厂</h4><p>实例工厂的意思是获取对象实例的方法不是静态的，所以你需要首先new 工厂类，再调用普通的实例方法：<br><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实例工厂</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DaoFactory</span> &#123;</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> FactoryDao <span class="title">getFactoryDaoImpl</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> FactoryDaoImpl();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringAction</span> &#123;</span></span><br><span class="line">  <span class="keyword">private</span> FactoryDao factoryDao; <span class="comment">//注入对象</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFactoryDao</span><span class="params">(FactoryDao factoryDao)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.factoryDao = factoryDao;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"springAction"</span> <span class="attr">class</span>=<span class="string">"SpringAction"</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--使用实例工厂的方法注入对象,对应下面的配置文件--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"factoryDao"</span> <span class="attr">ref</span>=<span class="string">"factoryDao"</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--此处获取对象的方式是从工厂类中获取实例方法--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"daoFactory"</span> <span class="attr">class</span>=<span class="string">"com.DaoFactory"</span>&gt;</span><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">name</span>=<span class="string">"factoryDao"</span> <span class="attr">factory-bean</span>=<span class="string">"daoFactory"</span> <span class="attr">factory-method</span>=<span class="string">"getFactoryDaoImpl"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h3 id="5种自动装配方式"><a href="#5种自动装配方式" class="headerlink" title="5种自动装配方式"></a>5种自动装配方式</h3><p>Spring 装配包括手动装配和自动装配，手动装配是有基于xml 装配、构造方法、setter 方法等自动装配有五种自动装配的方式，可以用来指导Spring 容器用自动装配方式来进行依赖注入。  </p>
<ol>
<li>no：默认的方式是不进行自动装配，通过显式设置ref 属性来进行装配。</li>
<li>byName：通过参数名 自动装配，Spring 容器在配置文件中发现bean 的autowire 属性被设置成byname，之后容器试图匹配、装配和该bean 的属性具有相同名字的bean。</li>
<li>byType：通过参数类型自动装配，Spring 容器在配置文件中发现bean 的autowire 属性被设置成byType，之后容器试图匹配、装配和该bean 的属性具有相同类型的bean。如果有多个bean 符合条件，则抛出错误。</li>
<li>constructor：这个方式类似于byType， 但是要提供给构造器参数，如果没有确定的带参数的构造器参数类型，将会抛出异常。</li>
<li>autodetect：首先尝试使用constructor 来自动装配，如果无法工作，则使用byType 方式。</li>
</ol>
<h2 id="Spring-AOP原理"><a href="#Spring-AOP原理" class="headerlink" title="Spring AOP原理"></a>Spring AOP原理</h2><h3 id="概念-1"><a href="#概念-1" class="headerlink" title="概念"></a>概念</h3><p>“横切”的技术，剖解开封装的对象内部，并将那些影响了多个类的公共行为封装到一个可重用模块，并将其命名为”Aspect”，即切面。所谓”切面”，简单说就是那些与业务无关，却为业务模块所共同调用的逻辑或责任封装起来，便于减少系统的重复代码，降低模块之间的耦合度，并有利于未来的可操作性和可维护性。<br>使用”横切”技术，AOP 把软件系统分为两个部分：核心关注点和横切关注点。业务处理的主要流程是核心关注点，与之关系不大的部分是横切关注点。横切关注点的一个特点是，他们经常发生在核心关注点的多处，而各处基本相似，比如权限认证、日志、事物。AOP 的作用在于分离系统中的各种关注点，将核心关注点和横切关注点分离开来。<br>AOP 主要应用场景有：  </p>
<ol>
<li>Authentication 权限</li>
<li>Caching 缓存</li>
<li>Context passing 内容传递</li>
<li>Error handling 错误处理</li>
<li>Lazy loading 懒加载</li>
<li>Debugging 调试</li>
<li>logging, tracing, profiling and monitoring 记录跟踪 优化 校准</li>
<li>Performance optimization 性能优化</li>
<li>Persistence 持久化</li>
<li>Resource pooling 资源池</li>
<li>Synchronization 同步</li>
<li>Transactions 事务</li>
</ol>
<h3 id="AOP核心概念"><a href="#AOP核心概念" class="headerlink" title="AOP核心概念"></a>AOP核心概念</h3><ol>
<li>切面（aspect）：类是对物体特征的抽象，切面就是对横切关注点的抽象  </li>
<li>横切关注点：对哪些方法进行拦截，拦截后怎么处理，这些关注点称之为横切关注点。  </li>
<li>连接点（joinpoint）：被拦截到的点，因为Spring 只支持方法类型的连接点，所以在Spring  中连接点指的就是被拦截到的方法，实际上连接点还可以是字段或者构造器。  </li>
<li>切入点（pointcut）：对连接点进行拦截的定义  </li>
<li>通知（advice）：所谓通知指的就是指拦截到连接点之后要执行的代码，通知分为前置、后置、异常、最终、环绕通知五类。</li>
<li>目标对象：代理的目标对象</li>
<li>织入（weave）：将切面应用到目标对象并导致代理对象创建的过程</li>
<li>引入（introduction）：在不修改代码的前提下，引入可以在运行期为类动态地添加一些方法或字段。</li>
</ol>
<p><img src="/2018/07/09/2018-07-09-spring-principle/spring-aop.jpg" alt="spring-aop"></p>
<h3 id="AOP两种代理方式"><a href="#AOP两种代理方式" class="headerlink" title="AOP两种代理方式"></a>AOP两种代理方式</h3><p>Spring 提供了两种方式来生成代理对象: JDKProxy 和Cglib，具体使用哪种方式生成由AopProxyFactory 根据AdvisedSupport 对象的配置来决定。默认的策略是如果目标类是接口，则使用JDK 动态代理技术，否则使用Cglib 来生成代理。</p>
<h4 id="JDK动态接口代理"><a href="#JDK动态接口代理" class="headerlink" title="JDK动态接口代理"></a>JDK动态接口代理</h4><ol>
<li>JDK 动态代理主要涉及到java.lang.reflect 包中的两个类：Proxy 和InvocationHandler。InvocationHandler 是一个接口，通过实现该接口定义横切逻辑，并通过反射机制调用目标类的代码，动态将横切逻辑和业务逻辑编制在一起。Proxy 利用InvocationHandler 动态创建一个符合某一接口的实例，生成目标类的代理对象。</li>
</ol>
<h4 id="CGLib动态代理"><a href="#CGLib动态代理" class="headerlink" title="CGLib动态代理"></a>CGLib动态代理</h4><ol start="2">
<li>：CGLib 全称为Code Generation Library，是一个强大的高性能，高质量的代码生成类库，可以在运行期扩展Java 类与实现Java 接口，CGLib 封装了asm，可以再运行期动态生成新的class。和JDK 动态代理相比较：JDK 创建代理有一个限制，就是只能为接口创建代理实例，而对于没有通过接口定义业务方法的类，则可以通过CGLib 创建动态代理。</li>
</ol>
<h3 id="AOP实现原理"><a href="#AOP实现原理" class="headerlink" title="AOP实现原理"></a>AOP实现原理</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Aspect</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TransactionDemo</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Pointcut</span>(value=<span class="string">"execution(* com.yangxin.core.service.*.*.*(..))"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">point</span><span class="params">()</span></span>&#123;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span>(value=<span class="string">"point()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">before</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"transaction begin"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@AfterReturning</span>(value = <span class="string">"point()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">after</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"transaction commit"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Around</span>(<span class="string">"point()"</span>)</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">around</span><span class="params">(ProceedingJoinPoint joinPoint)</span> <span class="keyword">throws</span> Throwable</span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"transaction begin"</span>);</span><br><span class="line">    joinPoint.proceed();</span><br><span class="line">    System.out.println(<span class="string">"transaction commit"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/2018/07/09/2018-07-09-spring-principle/spring-aop-2.jpg" alt="spring-aop"></p>
<h2 id="Spring-MVC原理"><a href="#Spring-MVC原理" class="headerlink" title="Spring MVC原理"></a>Spring MVC原理</h2><p>Spring 的模型-视图-控制器（MVC）框架是围绕一个DispatcherServlet 来设计的，这个Servlet会把请求分发给各个处理器，并支持可配置的处理器映射、视图渲染、本地化、时区与主题渲染等，甚至还能支持文件上传。</p>
<h3 id="MVC流程"><a href="#MVC流程" class="headerlink" title="MVC流程"></a>MVC流程</h3><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-mvc-process.jpg" alt="spring-mvc-process"></p>
<h4 id="Http请求到DispatcherServlet"><a href="#Http请求到DispatcherServlet" class="headerlink" title="Http请求到DispatcherServlet"></a>Http请求到DispatcherServlet</h4><p>(1) 客户端请求提交到DispatcherServlet。</p>
<h4 id="HandlerMapping寻找处理器"><a href="#HandlerMapping寻找处理器" class="headerlink" title="HandlerMapping寻找处理器"></a>HandlerMapping寻找处理器</h4><p>(2) 由DispatcherServlet 控制器查询一个或多个HandlerMapping，找到处理请求的Controller。</p>
<h4 id="调用处理器Controller"><a href="#调用处理器Controller" class="headerlink" title="调用处理器Controller"></a>调用处理器Controller</h4><p>(3) DispatcherServlet 将请求提交到Controller。</p>
<h4 id="Controller调用业务逻辑处理后，返回ModelAndView"><a href="#Controller调用业务逻辑处理后，返回ModelAndView" class="headerlink" title="Controller调用业务逻辑处理后，返回ModelAndView"></a>Controller调用业务逻辑处理后，返回ModelAndView</h4><p>(4)(5)调用业务处理和返回结果：Controller 调用业务逻辑处理后，返回ModelAndView。</p>
<h4 id="DispatcherServlet查询ModelAndView"><a href="#DispatcherServlet查询ModelAndView" class="headerlink" title="DispatcherServlet查询ModelAndView"></a>DispatcherServlet查询ModelAndView</h4><p>(6)(7)处理视图映射并返回模型： DispatcherServlet 查询一个或多个ViewResoler 视图解析器，找到ModelAndView 指定的视图。</p>
<h4 id="ModelAndView反馈浏览器HTTP"><a href="#ModelAndView反馈浏览器HTTP" class="headerlink" title="ModelAndView反馈浏览器HTTP"></a>ModelAndView反馈浏览器HTTP</h4><p>(8) Http 响应：视图负责将结果显示到客户端。</p>
<h3 id="MVC常用注解"><a href="#MVC常用注解" class="headerlink" title="MVC常用注解"></a>MVC常用注解</h3><p><img src="/2018/07/09/2018-07-09-spring-principle/spring-mvc-annotation.jpg" alt="spring-mvc-annotation"></p>
<h2 id="Spring-Boot原理"><a href="#Spring-Boot原理" class="headerlink" title="Spring Boot原理"></a>Spring Boot原理</h2><p>Spring Boot 是由Pivotal 团队提供的全新框架，其设计目的是用来简化新Spring 应用的初始搭建以及开发过程。该框架使用了特定的方式来进行配置，从而使开发人员不再需要定义样板化的配置。通过这种方式，Spring Boot 致力于在蓬勃发展的快速应用开发领域(rapid applicationdevelopment)成为领导者。其特点如下：</p>
<ol>
<li>创建独立的Spring应用程序</li>
<li>嵌入的Tomcat，无需部署WAR文件</li>
<li>简化Maven配置</li>
<li>自动配置Spring</li>
<li>提供生产就绪型功能，如指标，健康检查和外部配置</li>
<li>绝对没有代码生成和对XML没有要求配置</li>
</ol>
<h2 id="JPA原理"><a href="#JPA原理" class="headerlink" title="JPA原理"></a>JPA原理</h2><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><p>事务是计算机应用中不可或缺的组件模型，它保证了用户操作的原子性 ( Atomicity )、一致性( Consistency )、隔离性 ( Isolation ) 和持久性 ( Durabilily )。</p>
<h3 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h3><p>紧密依赖于底层资源管理器（例如数据库连接 )，事务处理局限在当前事务资源内。此种事务处理方式不存在对应用服务器的依赖，因而部署灵活却无法支持多数据源的分布式事务。在数据库连接中使用本地事务示例如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transferAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Connection conn = <span class="keyword">null</span>;</span><br><span class="line">  Statement stmt = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    conn = getDataSource().getConnection();</span><br><span class="line">    <span class="comment">// 将自动提交，true则数据库将会把每一次数据更新认定为一个事务并自动提交</span></span><br><span class="line">    conn.setAutoCommit(<span class="keyword">false</span>);</span><br><span class="line">    stmt = conn.createStatement();</span><br><span class="line">    <span class="comment">// A账号金额减少500</span></span><br><span class="line">    stmt.execute(<span class="string">"update t_account set amount = amount - 500 where account_id = 'A'"</span>);</span><br><span class="line">    <span class="comment">// B账户金额增加500</span></span><br><span class="line">    stmt.execute(<span class="string">"update t_account set amount = amount + 500 where account_id = 'B'"</span>);</span><br><span class="line">    <span class="comment">// 提交事务</span></span><br><span class="line">    conn.commit();</span><br><span class="line">    <span class="comment">// 事务提交：转账的两步操作同时成功</span></span><br><span class="line">  &#125; <span class="keyword">catch</span>(SQLException sqle)&#123;</span><br><span class="line">    <span class="comment">// 发生异常，回滚操作</span></span><br><span class="line">    conn.rollback();</span><br><span class="line">    <span class="comment">// 事务回滚：转账两步操作撤销</span></span><br><span class="line">    stmt.close();</span><br><span class="line">    conn.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="分布式事务"><a href="#分布式事务" class="headerlink" title="分布式事务"></a>分布式事务</h3><p>Java 事务编程接口（JTA：Java Transaction API）和 Java 事务服务 (JTS；Java TransactionService) 为 J2EE 平台提供了分布式事务服务。分布式事务（Distributed Transaction）包括事务管理器（ Transaction Manager ）和一个或多个支持 XA 协议的资源管理器 ( ResourceManager )。我们可以将资源管理器看做任意类型的持久化数据存储；事务管理器承担着所有事务参与单元的协调与控制。</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">transferAccount</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  UserTransaction userTx = <span class="keyword">null</span>;</span><br><span class="line">  Connection connA = <span class="keyword">null</span>; Statement stmtA = <span class="keyword">null</span>;</span><br><span class="line">  Connection connB = <span class="keyword">null</span>; Statement stmtB = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">    <span class="comment">// 获得 Transaction 管理对象</span></span><br><span class="line">    userTx = (UserTransaction)getContext().lookup(<span class="string">"java:comp/UserTransaction"</span>);</span><br><span class="line">    connA = getDataSourceA().getConnection();<span class="comment">// 从数据库 A 中取得数据库连接</span></span><br><span class="line">    connB = getDataSourceB().getConnection();<span class="comment">// 从数据库 B 中取得数据库连接</span></span><br><span class="line">    userTx.begin(); <span class="comment">// 启动事务</span></span><br><span class="line">    stmtA = connA.createStatement();<span class="comment">// 将 A 账户中的金额减少 500</span></span><br><span class="line">    stmtA.execute(<span class="string">"update t_account set amount = amount - 500 where account_id = 'A'"</span>);</span><br><span class="line">    <span class="comment">// 将 B 账户中的金额增加 500</span></span><br><span class="line">    stmtB = connB.createStatement();</span><br><span class="line">    stmtB.execute(<span class="string">"update t_account set amount = amount + 500 where account_id =  'B'"</span>);</span><br><span class="line">    userTx.commit();<span class="comment">// 提交事务</span></span><br><span class="line">    <span class="comment">// 事务提交：转账的两步操作同时成功（数据库 A 和数据库 B 中的数据被同时更新）</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(SQLException exception)&#123;</span><br><span class="line">      <span class="comment">// 发生异常，回滚在本事务中的操纵</span></span><br><span class="line">      userTx.rollback();<span class="comment">// 事务回滚：数据库 A 和数据库 B 中的数据更新被同时撤销</span></span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception e)&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="两阶段提交"><a href="#两阶段提交" class="headerlink" title="两阶段提交"></a>两阶段提交</h4><p>两阶段提交主要保证了分布式事务的原子性：即所有结点要么全做要么全不做，所谓的两个阶段是指：第一阶段：准备阶段；第二阶段：提交阶段。<br><img src="/2018/07/09/2018-07-09-spring-principle/transaction.jpg" alt="transaction"></p>
<h5 id="1-准备阶段"><a href="#1-准备阶段" class="headerlink" title="1 准备阶段"></a>1 准备阶段</h5><p>事务协调者(事务管理器)给每个参与者(资源管理器)发送Prepare 消息，每个参与者要么直接返回失败(如权限验证失败)，要么在本地执行事务，写本地的redo 和undo 日志，但不提交，到达一种“万事俱备，只欠东风”的状态。</p>
<h5 id="2-提交阶段"><a href="#2-提交阶段" class="headerlink" title="2 提交阶段"></a>2 提交阶段</h5><p>如果协调者收到了参与者的失败消息或者超时，直接给每个参与者发送回滚(Rollback)消息；否则，发送提交(Commit)消息；参与者根据协调者的指令执行提交或者回滚操作，释放所有事务处理过程中使用的锁资源。(注意:必须在最后阶段释放锁资源)将提交分成两阶段进行的目的很明确，就是尽可能晚地提交事务，让事务在提交前尽可能地完成所有能完成的工作。</p>
<h4 id="TCC方案"><a href="#TCC方案" class="headerlink" title="TCC方案"></a>TCC方案</h4><p>TCC的全程是：Try、Confirm、Cancel。</p>
<p>这个其实是用到了补偿的概念，分为了三个阶段：</p>
<p>1）Try阶段：这个阶段说的是对各个服务的资源做检测以及对资源进行锁定或者预留<br>2）Confirm阶段：这个阶段说的是在各个服务中执行实际的操作<br>3）Cancel阶段：如果任何一个服务的业务方法执行出错，那么这里就需要进行补偿，就是执行已经执行成功的业务逻辑的回滚操作</p>
<p>给大家举个例子吧，比如说跨银行转账的时候，要涉及到两个银行的分布式事务，如果用TCC方案来实现，思路是这样的：</p>
<p>1）Try阶段：先把两个银行账户中的资金给它冻结住就不让操作了<br>2）Confirm阶段：执行实际的转账操作，A银行账户的资金扣减，B银行账户的资金增加<br>3）Cancel阶段：如果任何一个银行的操作执行失败，那么就需要回滚进行补偿，就是比如A银行账户如果已经扣减了，但是B银行账户资金增加失败了，那么就得把A银行账户资金给加回去</p>
<p>这种方案说实话几乎很少用人使用，我们用的也比较少，但是也有使用的场景。因为这个事务回滚实际上是严重依赖于你自己写代码来回滚和补偿了，会造成补偿代码巨大，非常之恶心。</p>
<p>比如说我们，一般来说跟钱相关的，跟钱打交道的，支付、交易相关的场景，我们会用TCC，严格严格保证分布式事务要么全部成功，要么全部自动回滚，严格保证资金的正确性，在资金上出现问题</p>
<p>比较适合的场景：这个就是除非你是真的一致性要求太高，是你系统中核心之核心的场景，比如常见的就是资金类的场景，那你可以用TCC方案了，自己编写大量的业务逻辑，自己判断一个事务中的各个环节是否ok，不ok就执行补偿/回滚代码。</p>
<p>而且最好是你的各个业务执行的时间都比较短。</p>
<p>但是说实话，一般尽量别这么搞，自己手写回滚逻辑，或者是补偿逻辑，实在太恶心了，那个业务代码很难维护。</p>
<h4 id="本地消息表"><a href="#本地消息表" class="headerlink" title="本地消息表"></a>本地消息表</h4><p>国外的ebay搞出来的这么一套思想</p>
<p>这个大概意思是这样的</p>
<p>1）A系统在自己本地一个事务里操作同时，插入一条数据到消息表<br>2）接着A系统将这个消息发送到MQ中去<br>3）B系统接收到消息之后，在一个事务里，往自己本地消息表里插入一条数据，同时执行其他的业务操作，如果这个消息已经被处理过了，那么此时这个事务会回滚，这样保证不会重复处理消息<br>4）B系统执行成功之后，就会更新自己本地消息表的状态以及A系统消息表的状态<br>5）如果B系统处理失败了，那么就不会更新消息表状态，那么此时A系统会定时扫描自己的消息表，如果有没处理的消息，会再次发送到MQ中去，让B再次处理<br>6）这个方案保证了最终一致性，哪怕B事务失败了，但是A会不断重发消息，直到B那边成功为止</p>
<p>这个方案说实话最大的问题就在于严重依赖于数据库的消息表来管理事务啥的？？？这个会导致如果是高并发场景咋办呢？咋扩展呢？所以一般确实很少用</p>
<h4 id="可靠消息最终一致性方案"><a href="#可靠消息最终一致性方案" class="headerlink" title="可靠消息最终一致性方案"></a>可靠消息最终一致性方案</h4><p>这个的意思，就是干脆不要用本地的消息表了，直接基于MQ来实现事务。比如阿里的RocketMQ就支持消息事务。</p>
<p>大概的意思就是：<br>1）A系统先发送一个prepared消息到mq，如果这个prepared消息发送失败那么就直接取消操作别执行了<br>2）如果这个消息发送成功过了，那么接着执行本地事务，如果成功就告诉mq发送确认消息，如果失败就告诉mq回滚消息<br>3）如果发送了确认消息，那么此时B系统会接收到确认消息，然后执行本地的事务<br>4）mq会自动定时轮询所有prepared消息回调你的接口，问你，这个消息是不是本地事务处理失败了，所有没发送确认消息？那是继续重试还是回滚？一般来说这里你就可以查下数据库看之前本地事务是否执行，如果回滚了，那么这里也回滚吧。这个就是避免可能本地事务执行成功了，别确认消息发送失败了。<br>5）这个方案里，要是系统B的事务失败了咋办？重试咯，自动不断重试直到成功，如果实在是不行，要么就是针对重要的资金类业务进行回滚，比如B系统本地回滚后，想办法通知系统A也回滚；或者是发送报警由人工来手工回滚和补偿</p>
<p>这个还是比较合适的，目前国内互联网公司大都是这么玩儿的，要不你举用RocketMQ支持的，要不你就自己基于类似ActiveMQ？RabbitMQ？自己封装一套类似的逻辑出来，总之思路就是这样子的</p>
<h3 id="Mybatis-缓存"><a href="#Mybatis-缓存" class="headerlink" title="Mybatis 缓存"></a>Mybatis 缓存</h3><p>Mybatis 中有一级缓存和二级缓存，默认情况下一级缓存是开启的，而且是不能关闭的。一级缓存是指SqlSession 级别的缓存，当在同一个SqlSession 中进行相同的SQL 语句查询时，第二次以后的查询不会从数据库查询，而是直接从缓存中获取，一级缓存最多缓存1024 条SQL。二级缓存是指可以跨SqlSession 的缓存。是mapper 级别的缓存，对于mapper 级别的缓存不同的sqlsession 是可以共享的。</p>
<p><img src="/2018/07/09/2018-07-09-spring-principle/mybatis-cache.jpg" alt="Mybatis Cache"></p>
<h4 id="Mybatis的一级缓存原理-sqlsession-级别"><a href="#Mybatis的一级缓存原理-sqlsession-级别" class="headerlink" title="Mybatis的一级缓存原理(sqlsession 级别)"></a>Mybatis的一级缓存原理(sqlsession 级别)</h4><p>第一次发出一个查询sql，sql 查询结果写入sqlsession 的一级缓存中，缓存使用的数据结构是一个map。<br>key：MapperID+offset+limit+Sql+所有的入参<br>value：用户信息<br>同一个sqlsession 再次发出相同的sql，就从缓存中取出数据。如果两次中间出现commit 操作（修改、添加、删除），本sqlsession 中的一级缓存区域全部清空，下次再去缓存中查询不到所以要从数据库查询，从数据库查询到再写入缓存。  </p>
<h4 id="二级缓存原理-mapper-基本"><a href="#二级缓存原理-mapper-基本" class="headerlink" title="二级缓存原理(mapper 基本)"></a>二级缓存原理(mapper 基本)</h4><p>二级缓存的范围是mapper 级别（mapper 同一个命名空间），mapper 以命名空间为单位创建缓存数据结构，结构是map。mybatis 的二级缓存是通过CacheExecutor 实现的。CacheExecutor其实是Executor 的代理对象。所有的查询操作，在CacheExecutor 中都会先匹配缓存中是否存在，不存在则查询数据库。<br>key：MapperID+offset+limit+Sql+所有的入参<br>具体使用需要配置：  </p>
<ol>
<li>Mybatis 全局配置中启用二级缓存配置</li>
<li>在对应的Mapper.xml 中配置cache 节点</li>
<li>在对应的select 查询节点中添加useCache=true</li>
</ol>

      
    </div>

    

    
    
    

    

    
      
    
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/java/" rel="tag"># java</a>
          
            <a href="/tags/spring/" rel="tag"># spring</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/06/07/2018-06-07-java-cpu-100-resolve/" rel="next" title="Java CPU 100%排查问题与解决">
                <i class="fa fa-chevron-left"></i> Java CPU 100%排查问题与解决
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/08/11/2018-08-11-java-common-library/" rel="prev" title="Java 常用类库">
                Java 常用类库 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Shado Fung">
            
              <p class="site-author-name" itemprop="name">Shado Fung</p>
              <p class="site-description motion-element" itemprop="description">Java Developer</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">50</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">10</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">29</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://github.com/ShadoFung" title="GitHub &rarr; https://github.com/ShadoFung" rel="noopener" target="_blank"><i class="fa fa-fw fa-github"></i>GitHub</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="mailto:ShadoFung@gmail.com" title="E-Mail &rarr; mailto:ShadoFung@gmail.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/u/3247997722" title="Weibo &rarr; https://weibo.com/u/3247997722" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://stackoverflow.com/users/10678850/shado-fung" title="StackOverflow &rarr; https://stackoverflow.com/users/10678850/shado-fung" rel="noopener" target="_blank"><i class="fa fa-fw fa-stack-overflow"></i>StackOverflow</a>
                </span>
              
            </div>
          

          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-block">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                推荐阅读
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://docs.oracle.com/javase/tutorial/" title="https://docs.oracle.com/javase/tutorial/" rel="noopener" target="_blank">Oracle Java Tutorial</a>
                  </li>
                
                  <li class="links-of-blogroll-item">
                    <a href="https://spring.io/guides" title="https://spring.io/guides" rel="noopener" target="_blank">Spring Guides</a>
                  </li>
                
              </ul>
            </div>
          

          
            
          
          

        </div>
      </div>

      
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring特点"><span class="nav-number">2.</span> <span class="nav-text">Spring特点</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#轻量级"><span class="nav-number">2.1.</span> <span class="nav-text">轻量级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#控制反转"><span class="nav-number">2.2.</span> <span class="nav-text">控制反转</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#面向切面"><span class="nav-number">2.3.</span> <span class="nav-text">面向切面</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容器"><span class="nav-number">2.4.</span> <span class="nav-text">容器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#框架集合"><span class="nav-number">2.5.</span> <span class="nav-text">框架集合</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring核心组件"><span class="nav-number">3.</span> <span class="nav-text">Spring核心组件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring常用模块"><span class="nav-number">4.</span> <span class="nav-text">Spring常用模块</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring主要包"><span class="nav-number">5.</span> <span class="nav-text">Spring主要包</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用注解"><span class="nav-number">6.</span> <span class="nav-text">常用注解</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring第三方结合"><span class="nav-number">7.</span> <span class="nav-text">Spring第三方结合</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-IOC原理"><span class="nav-number">8.</span> <span class="nav-text">Spring IOC原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念"><span class="nav-number">8.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-容器高层视图"><span class="nav-number">8.2.</span> <span class="nav-text">Spring 容器高层视图</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#IOC容器实现"><span class="nav-number">8.3.</span> <span class="nav-text">IOC容器实现</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#BeanFactory-框架基础设施"><span class="nav-number">8.3.1.</span> <span class="nav-text">BeanFactory-框架基础设施</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#BeanDefinitionRegistry-注册表"><span class="nav-number">8.3.1.1.</span> <span class="nav-text">BeanDefinitionRegistry 注册表</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#BeanFactory-顶层接口"><span class="nav-number">8.3.1.2.</span> <span class="nav-text">BeanFactory 顶层接口</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ListableBeanFactory"><span class="nav-number">8.3.1.3.</span> <span class="nav-text">ListableBeanFactory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#HierarchicalBeanFactory父子级联"><span class="nav-number">8.3.1.4.</span> <span class="nav-text">HierarchicalBeanFactory父子级联</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ConfigurableBeanFactory"><span class="nav-number">8.3.1.5.</span> <span class="nav-text">ConfigurableBeanFactory</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#AutowireCapableBeanFactory-自动装配"><span class="nav-number">8.3.1.6.</span> <span class="nav-text">AutowireCapableBeanFactory 自动装配</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SingletonBeanRegistry-运行期间注册单例-Bean"><span class="nav-number">8.3.1.7.</span> <span class="nav-text">SingletonBeanRegistry 运行期间注册单例 Bean</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#依赖日志框架"><span class="nav-number">8.3.1.8.</span> <span class="nav-text">依赖日志框架</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ApplicationContext"><span class="nav-number">8.3.2.</span> <span class="nav-text">ApplicationContext</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#WebApplication-体系架构"><span class="nav-number">8.3.3.</span> <span class="nav-text">WebApplication 体系架构</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Bean-作用域"><span class="nav-number">8.4.</span> <span class="nav-text">Spring Bean 作用域</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#singleton-单例模式-多线程下不安全"><span class="nav-number">8.4.1.</span> <span class="nav-text">singleton:单例模式(多线程下不安全)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#prototype-原型模式每次使用时创建"><span class="nav-number">8.4.2.</span> <span class="nav-text">prototype:原型模式每次使用时创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Request-一次-request-一个实例"><span class="nav-number">8.4.3.</span> <span class="nav-text">Request: 一次 request 一个实例</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#session"><span class="nav-number">8.4.4.</span> <span class="nav-text">session</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#global-Session"><span class="nav-number">8.4.5.</span> <span class="nav-text">global Session</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Bean-生命周期"><span class="nav-number">8.5.</span> <span class="nav-text">Spring Bean 生命周期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#实例化"><span class="nav-number">8.5.1.</span> <span class="nav-text">实例化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#IOC-依赖注入"><span class="nav-number">8.5.2.</span> <span class="nav-text">IOC 依赖注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setBeanName-实现"><span class="nav-number">8.5.3.</span> <span class="nav-text">setBeanName 实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#BeanFactoryAware-实现"><span class="nav-number">8.5.4.</span> <span class="nav-text">BeanFactoryAware 实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ApplicationContextAware-实现"><span class="nav-number">8.5.5.</span> <span class="nav-text">ApplicationContextAware 实现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#postProcessBeforeInitialization-接口实现-初始化预处理"><span class="nav-number">8.5.6.</span> <span class="nav-text">postProcessBeforeInitialization 接口实现-初始化预处理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#init-method"><span class="nav-number">8.5.7.</span> <span class="nav-text">init-method</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Destroy-过期自动清理阶段"><span class="nav-number">8.5.8.</span> <span class="nav-text">Destroy 过期自动清理阶段</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#destroy-method-自配置清理"><span class="nav-number">8.5.9.</span> <span class="nav-text">destroy-method 自配置清理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring依赖注入的四种方式"><span class="nav-number">8.6.</span> <span class="nav-text">Spring依赖注入的四种方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#构造器注入"><span class="nav-number">8.6.1.</span> <span class="nav-text">构造器注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#setter方法注入"><span class="nav-number">8.6.2.</span> <span class="nav-text">setter方法注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#静态工厂注入"><span class="nav-number">8.6.3.</span> <span class="nav-text">静态工厂注入</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#实例工厂"><span class="nav-number">8.6.4.</span> <span class="nav-text">实例工厂</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#5种自动装配方式"><span class="nav-number">8.7.</span> <span class="nav-text">5种自动装配方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-AOP原理"><span class="nav-number">9.</span> <span class="nav-text">Spring AOP原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概念-1"><span class="nav-number">9.1.</span> <span class="nav-text">概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOP核心概念"><span class="nav-number">9.2.</span> <span class="nav-text">AOP核心概念</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOP两种代理方式"><span class="nav-number">9.3.</span> <span class="nav-text">AOP两种代理方式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#JDK动态接口代理"><span class="nav-number">9.3.1.</span> <span class="nav-text">JDK动态接口代理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CGLib动态代理"><span class="nav-number">9.3.2.</span> <span class="nav-text">CGLib动态代理</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AOP实现原理"><span class="nav-number">9.4.</span> <span class="nav-text">AOP实现原理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-MVC原理"><span class="nav-number">10.</span> <span class="nav-text">Spring MVC原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#MVC流程"><span class="nav-number">10.1.</span> <span class="nav-text">MVC流程</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Http请求到DispatcherServlet"><span class="nav-number">10.1.1.</span> <span class="nav-text">Http请求到DispatcherServlet</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#HandlerMapping寻找处理器"><span class="nav-number">10.1.2.</span> <span class="nav-text">HandlerMapping寻找处理器</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#调用处理器Controller"><span class="nav-number">10.1.3.</span> <span class="nav-text">调用处理器Controller</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Controller调用业务逻辑处理后，返回ModelAndView"><span class="nav-number">10.1.4.</span> <span class="nav-text">Controller调用业务逻辑处理后，返回ModelAndView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#DispatcherServlet查询ModelAndView"><span class="nav-number">10.1.5.</span> <span class="nav-text">DispatcherServlet查询ModelAndView</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ModelAndView反馈浏览器HTTP"><span class="nav-number">10.1.6.</span> <span class="nav-text">ModelAndView反馈浏览器HTTP</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MVC常用注解"><span class="nav-number">10.2.</span> <span class="nav-text">MVC常用注解</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Spring-Boot原理"><span class="nav-number">11.</span> <span class="nav-text">Spring Boot原理</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JPA原理"><span class="nav-number">12.</span> <span class="nav-text">JPA原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务"><span class="nav-number">12.1.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地事务"><span class="nav-number">12.2.</span> <span class="nav-text">本地事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#分布式事务"><span class="nav-number">12.3.</span> <span class="nav-text">分布式事务</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#两阶段提交"><span class="nav-number">12.3.1.</span> <span class="nav-text">两阶段提交</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#1-准备阶段"><span class="nav-number">12.3.1.1.</span> <span class="nav-text">1 准备阶段</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#2-提交阶段"><span class="nav-number">12.3.1.2.</span> <span class="nav-text">2 提交阶段</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#TCC方案"><span class="nav-number">12.3.2.</span> <span class="nav-text">TCC方案</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#本地消息表"><span class="nav-number">12.3.3.</span> <span class="nav-text">本地消息表</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可靠消息最终一致性方案"><span class="nav-number">12.3.4.</span> <span class="nav-text">可靠消息最终一致性方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Mybatis-缓存"><span class="nav-number">12.4.</span> <span class="nav-text">Mybatis 缓存</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Mybatis的一级缓存原理-sqlsession-级别"><span class="nav-number">12.4.1.</span> <span class="nav-text">Mybatis的一级缓存原理(sqlsession 级别)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#二级缓存原理-mapper-基本"><span class="nav-number">12.4.2.</span> <span class="nav-text">二级缓存原理(mapper 基本)</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </div>
      <!--/noindex-->
      

      
        <div class="back-to-top">
          <i class="fa fa-arrow-up"></i>
          
            <span id="scrollpercent"><span>0</span>%</span>
          
        </div>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love" id="animate">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Shado Fung</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
    <span title="站点总字数">239k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
    <span title="站点阅读时长">6:38</span>
  
</div>









        




  <script>
    (function() {
      var hm = document.createElement("script");
      hm.src = "//tajs.qq.com/stats?sId=66183427";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>





        
      </div>
    </footer>

    

    

    

    
  </div>

  

<script>
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  <script src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>


  


  <script src="/js/src/utils.js?v=7.0.0"></script>

  <script src="/js/src/motion.js?v=7.0.0"></script>



  
  


  <script src="/js/src/affix.js?v=7.0.0"></script>

  <script src="/js/src/schemes/pisces.js?v=7.0.0"></script>




  
  <script src="/js/src/scrollspy.js?v=7.0.0"></script>
<script src="/js/src/post-details.js?v=7.0.0"></script>



  


  <script src="/js/src/bootstrap.js?v=7.0.0"></script>



  


  


  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url).replace(/\/{2,}/g, '/');
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x"></i></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x"></i></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  
  <script>
    (function(){
      var bp = document.createElement('script');
      var curProtocol = window.location.protocol.split(':')[0];
      if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js'; 
      }
      else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
      }
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(bp, s);
    })();
  </script>


  

  

  

  

  

  

  

  
  <style>
    .copy-btn {
      display: inline-block;
      padding: 6px 12px;
      font-size: 13px;
      font-weight: 700;
      line-height: 20px;
      color: #333;
      white-space: nowrap;
      vertical-align: middle;
      cursor: pointer;
      background-color: #eee;
      background-image: linear-gradient(#fcfcfc, #eee);
      border: 1px solid #d5d5d5;
      border-radius: 3px;
      user-select: none;
      outline: 0;
    }

    .highlight-wrap .copy-btn {
      transition: opacity .3s ease-in-out;
      opacity: 0;
      padding: 2px 6px;
      position: absolute;
      right: 4px;
      top: 8px;
    }

    .highlight-wrap:hover .copy-btn,
    .highlight-wrap .copy-btn:focus {
      opacity: 1
    }

    .highlight-wrap {
      position: relative;
    }
  </style>
  <script>
    $('.highlight').each(function(i, e) {
      var $wrap = $('<div>').addClass('highlight-wrap');
      $(e).after($wrap);
      $wrap.append($('<button>').addClass('copy-btn').append('复制').on('click', function(e) {
        var code = $(this).parent().find('.code').find('.line').map(function(i, e) {
          return $(e).text();
        }).toArray().join('\n');
        var ta = document.createElement('textarea');
        var range = document.createRange(); //For Chrome
        var sel = window.getSelection(); //For Chrome
        var yPosition = window.pageYOffset || document.documentElement.scrollTop;
        ta.style.top = yPosition + 'px'; //Prevent page scroll
        ta.style.position = 'absolute';
        ta.style.opacity = '0';
        ta.value = code;
        ta.textContent = code; //For FireFox
        ta.contentEditable = true;
        ta.readOnly = false;
        document.body.appendChild(ta);
        range.selectNode(ta);
        sel.removeAllRanges();
        sel.addRange(range);
        ta.setSelectionRange(0, code.length);
        var result = document.execCommand('copy');
        
          if (result) $(this).text('复制成功');
          else $(this).text('复制失败');
        
        ta.blur(); //For iOS
        $(this).blur();
      })).on('mouseleave', function(e) {
        var $b = $(this).find('.copy-btn');
        setTimeout(function() {
          $b.text('复制');
        }, 300);
      }).append(e);
    })
  </script>


<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"debug":true,"model":{"jsonPath":"/live2dw/assets/wanko.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":1},"log":false});</script></body>
</html>
